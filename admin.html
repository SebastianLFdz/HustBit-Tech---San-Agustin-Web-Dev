<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo | San Agustín Cocinas</title>
  <link rel="stylesheet" href="Bootstrap/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    :root{
      --gold:#bfa888;
    }
    body{
      font-family:'Poppins',sans-serif;
      background:#1e232d;
      color:#fff;
      overflow-x:hidden;
    }
    .navbar{
      background:rgba(30,30,35,.8)!important;
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .navbar-brand{color:#fff!important;font-weight:700;}
    .nav-link{color:#ddd!important;font-weight:500;margin-right:.25rem;}
    .nav-link:hover{color:var(--gold)!important;}
    .nav-link.active{color:var(--gold)!important;}
    .dropdown-menu{
      background-color:#2e2e2e;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:10px;
      min-width:160px;
    }
    .dropdown-item{
      color:#ddd;
      font-weight:500;
    }
    .dropdown-item:hover{
      background-color:rgba(191,168,136,0.2);
      color:var(--gold);
    }
    .container-admin{
      margin-top:120px;
      text-align:center;
      /* Aumentamos el max-width para el simulador */
      max-width: 1140px; 
    }
    h1{color:var(--gold);font-weight:700;}
    hr{margin:30px auto;width:60%;opacity:.15;}
    footer{
      padding:36px 18px;
      border-top:1px solid rgba(255,255,255,0.08);
      color:#ddd;
      background:#262626;
      text-align:center;
    }
    .footer-bottom{margin-top:14px;font-size:13px;color:#aaa;}
    .whatsapp-float{
      position:fixed;right:22px;bottom:22px;width:62px;height:62px;border-radius:50%;
      background:linear-gradient(180deg,#25D366,#18b955);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:24px;z-index:1400;
      box-shadow:0 8px 30px rgba(0,0,0,0.25);
      transition:transform .18s ease;text-decoration:none;
    }
    .whatsapp-float:hover{transform:translateY(-6px);}

    /* --- INICIO: ESTILOS PARA SIMULADOR (Paso 1) --- */
    .hidden {
      display: none;
    }
    #simulador-seleccion h3 {
      color: var(--gold);
      margin-bottom: 20px;
    }
    .tipo-cocina-btn {
      background-color: #2a2f3a;
      border: 2px solid #444;
      border-radius: 10px;
      padding: 20px;
      color: #fff;
      text-decoration: none;
      transition: all 0.3s ease;
      display: block;
      height: 100%;
    }
    .tipo-cocina-btn:hover {
      background-color: #3a3f4a;
      border-color: var(--gold);
      color: var(--gold);
      transform: translateY(-5px);
    }
    .tipo-cocina-btn i {
      font-size: 40px;
      margin-bottom: 15px;
    }
    #simulador-area {
      position: relative;
      width: 100%;
      max-width: 1000px;
      margin: 20px auto;
      border: 1px solid #555;
      background-color: #111;
    }
    #simulador-fondo {
      width: 100%;
      height: auto;
      display: block;
      opacity: 0.5;
    }
    .mueble-slot {
      position: absolute;
      width: 100px; /* Ajustarás esto */
      height: 150px; /* Ajustarás esto */
      background-color: rgba(191, 168, 136, 0.2);
      border: 2px dashed var(--gold);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold);
      font-size: 24px;
      transition: all 0.2s ease;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      /* Forzar la impresión de la imagen de fondo */
      -webkit-print-color-adjust: exact; /* Para Chrome, Safari, Edge */
      print-color-adjust: exact;         /* Para Firefox */
    }
    .mueble-slot:hover {
      background-color: rgba(191, 168, 136, 0.4);
    }
    /* --- FIN: ESTILOS PARA SIMULADOR --- */

    
    /* --- INICIO: NUEVOS ESTILOS PARA MODAL (Paso 2) --- */
    .mueble-opcion {
      display: block;
      padding: 15px;
      background-color: #1e232d;
      border: 1px solid #444;
      border-radius: 8px;
      text-decoration: none;
      color: #fff;
      transition: all 0.2s ease;
      height: 100%;
      text-align: center;
    }
    .mueble-opcion:hover {
      border-color: var(--gold);
      background-color: #2a2f3a;
      transform: translateY(-3px);
    }
    .mueble-opcion img {
      width: 100%;
      height: 120px; /* Altura fija para la vista previa */
      object-fit: contain; /* Para que la imagen se ajuste sin deformarse */
      margin-bottom: 10px;
    }
    .mueble-opcion h6 {
      font-size: 14px;
      color: #ddd;
    }
    /* --- FIN: NUEVOS ESTILOS PARA MODAL --- */

    /* --- INICIO: NUEVOS ESTILOS PARA PREVIEW (Paso 3) --- */
    #carousel-mueble {
      border-radius: 8px;
      overflow: hidden;
      background-color: #1e232d;
    }
    .carousel-item img {
      width: 100%;
      height: 400px; /* Altura fija para el carrusel */
      object-fit: contain;
    }
    /* --- FIN: NUEVOS ESTILOS PARA PREVIEW --- */
    /* --- INICIO: ESTILOS SELECCIÓN DE FONDO (Paso 5) --- */
    .fondo-opcion {
      display: block;
      border: 3px solid #444;
      border-radius: 10px;
      overflow: hidden;
      text-decoration: none;
      color: #fff;
      transition: all 0.3s ease;
    }
    .fondo-opcion:hover {
      border-color: var(--gold);
      transform: translateY(-5px);
    }
    .fondo-opcion img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .fondo-opcion h6 {
      background-color: #2a2f3a;
      padding: 10px;
      margin: 0;
    }

    /* --- INICIO: ESTILOS DE IMPRESIÓN (Paso 5) --- */
    /* --- INICIO: ESTILOS DE IMPRESIÓN (Actualizado) --- */
    @media print {
      
      /* --- ¡NUEVO! CONTROL DE LA PÁGINA --- */
      @page {
        /* Sugiere tamaño Oficio (legal) y orientación horizontal */
        size: legal portrait; 
        /* Damos un margen para que no esté pegado a los bordes */
        margin: 1cm; 
      }

      /* Oculta todo lo que NO queremos imprimir */
      body {
        background-color: #fff !important; 
        color: #000 !important;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      .navbar,
      footer,
      .whatsapp-float,
      #simulador-seleccion,
      #simulador-seleccion-fondo,
      .container-admin > hr,
      .container-admin > p,
      #btn-exportar-pdf,
      .lead { /* Oculta el "Bienvenido..." */
        display: none !important;
      }
      
      /* Ajusta el contenedor principal para impresión */
      .container-admin {
        margin-top: 0;
        max-width: 100%; /* Ocupa todo el ancho de la hoja */
        width: 100%;
        text-align: left;
        padding: 0;
      }

      /* Muestra el título H1 centrado */
      h1 {
        text-align: center !important;
        color: #000 !important; /* Asegura color negro */
        font-size: 22pt;
      }
      
      #simulador-area,
      #simulador-resumen {
        display: block !important;
        visibility: visible !important;
        width: 100%; /* Ocupa todo el ancho */
        max-width: 100%;
        /* Evita que la imagen o la tabla se corten entre páginas */
        page-break-inside: avoid; 
      }

      #simulador-area {
        border: 1px solid #ccc;
        position: relative;
        height: auto; /* La altura se ajustará a la imagen */
        margin-bottom: 20px;
      }
      
      #simulador-fondo {
        opacity: 1; 
        width: 100%;
        height: auto;
        position: relative; /* Cambia a relativo para que fluya */
      }

      .mueble-slot {
        border: 1px solid rgba(0,0,0,0.5) !important;
        /* Forzar la impresión de fondos (muebles) */
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;         
      }
      
      /* Estilos para la tabla */
      #simulador-resumen h3 {
        color: #000 !important;
      }
      .table, .table-dark {
        color: #000 !important;
        --bs-table-bg: #fff; /* Tablas blancas en PDF */
        --bs-table-striped-bg: #f9f9f9;
        border: 1px solid #ddd;
      }
      .table th, .table td {
        color: #000 !important;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/">San Agustín Cocinas</a>
      <button class="navbar-toggler text-white" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="navCollapse" class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav align-items-center">
          <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="/about">Sobre Nosotros</a></li>
          <li class="nav-item"><a class="nav-link" href="/referencias">Referencias</a></li>
          <li class="nav-item"><a class="nav-link" href="/contacto">Contacto</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa-solid fa-user-circle me-1 text-warning"></i>
              {{ session['usuario'] }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="/admin">Mi cuenta</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/logout">Cerrar sesión</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container container-admin">
    <h1 class="mb-3">Panel Administrativo</h1>
    <p class="lead mb-4">Bienvenido, <strong>{{ session['usuario'] }}</strong>.</p>
    <p>Aquí podrás gestionar los modelos, materiales y proyectos.</p>
    <hr class="bg-light">

    <div id="simulador-seleccion">
      <h3 class="mb-4">Inicia tu simulación</h3>
      <p class="mb-4">Elige el tipo de cocina que quieres armar:</p>
      <div class="row justify-content-center g-4">
        
        <div class="col-md-4">
          <a href="#" class="tipo-cocina-btn" id="btn-cocina-pequena">
            <i class="fa-solid fa-kitchen-set"></i>
            <h4>Cocina Pequeña</h4>
            <p>(8 espacios)</p>
          </a>
        </div>
        
        <div class="col-md-4">
          <a href="#" class="tipo-cocina-btn" id="btn-cocina-l">
            <i class="fa-solid fa-layer-group"></i>
            <h4>Cocina en L</h4>
            <p>(10 espacios)</p>
          </a>
        </div>

        <div class="col-md-4">
          <a href="#" class="tipo-cocina-btn" id="btn-cocina-grande">
            <i class="fa-solid fa-draw-polygon"></i>
            <h4>Cocina Grande (Esquina)</h4>
            <p>(12 espacios)</p>
          </a>
        </div>

      </div>
    </div>

    <div id="simulador-seleccion-fondo" class="hidden">
      <h3 class="mb-4">Paso 2: Elige un fondo</h3>
      <p class="mb-4">Selecciona la imagen de fondo para tu simulación.</p>
      <div id="fondos-opciones-grid" class="row justify-content-center g-4">
        </div>
    </div>

    <div id="simulador-area" class="hidden">
      <img id="simulador-fondo" src="" alt="Fondo de cocina" /> 
      
      <div id="simulador-slots" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
    </div>

    <div id="simulador-resumen" class="hidden text-start mt-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-white mb-0">Desglose de Muebles</h3>
        <button id="btn-exportar-pdf" class="btn btn-warning">
          <i class="fa-solid fa-file-pdf me-2"></i>Exportar a PDF
        </button>
      </div>
      <p class="text-muted">Lista de módulos añadidos a la cocina.</p>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead>
            <tr>
              <th scope="col">Mueble</th>
              <th scope="col">Ancho</th>
              <th scope="col">Alto</th>
            </tr>
          </thead>
          <tbody id="lista-desglose-muebles">
            <tr>
              <td colspan="3" class="text-center text-muted">Aún no has añadido muebles.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <hr class="bg-light mt-5"> <p>Usa el menú de tu usuario (arriba a la derecha) para salir o revisar tu cuenta.</p>
  </div>
    
  <hr class="bg-light mt-5"> <p>Usa el menú de tu usuario (arriba a la derecha) para salir o revisar tu cuenta.</p>
  </div>

  <footer>
    <div class="container text-center">
      <div style="margin-bottom:12px;">
        <a class="me-3" href="https://www.facebook.com/sanagustincocinas/"><i class="fab fa-facebook fa-lg"></i></a>
        <a href="https://wa.me/528181382881"><i class="fab fa-whatsapp fa-lg"></i></a>
      </div>
      <div class="footer-bottom">
        Tel: 81 8138 2881 · Correo: 
        <a href="mailto:sanagustinstone@hotmail.com" style="color:inherit;">sanagustinstone@hotmail.com</a><br>
        © 2025 San Agustín Cocinas · Todos los derechos reservados.
      </div>
    </div>
  </footer>

  <a class="whatsapp-float" href="https://wa.me/528181382881" target="_blank"><i class="fab fa-whatsapp"></i></a>

  <div class="modal fade" id="modal-seleccion-mueble" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content" style="background-color: #2a2f3a; color: #fff;">
      
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="modal-titulo">Selecciona un mueble</h5>
        <button id="btn-volver-grid" type="button" class="btn btn-outline-light btn-sm me-auto ms-3 hidden">
          <i class="fa-solid fa-arrow-left me-1"></i> Volver
        </button>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        
        <div id="modal-cuerpo" class="row g-3">
          </div>

        <div id="modal-preview" class="hidden">
          <div class="row">
            <div class="col-md-8">
              <div id="carousel-mueble" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators" id="carousel-preview-indicators">
                  </div>
                <div class="carousel-inner" id="carousel-preview-inner">
                  </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-mueble" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carousel-mueble" data-bs-slide="next">
                  <span class="carousel-control-next-icon"></span>
                </button>
              </div>
            </div>
            
            <div class="col-md-4 d-flex flex-column justify-content-center text-center">
              <h4 id="preview-nombre-mueble" class="text-white">Nombre Mueble</h4>
              <p class="text-muted">Previsualiza las fotos y añádelo a tu cocina.</p>
              <button id="btn-add-mueble" class="btn btn-warning btn-lg mt-3">
                <i class="fa-solid fa-plus me-1"></i> Añadir a la Cocina
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
  <script src="Bootstrap/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. VARIABLES GLOBALES ---
      let baseDeDatosMuebles = [];
      let slotActivo = null;
      const modalElement = document.getElementById('modal-seleccion-mueble');
      const modalBootstrap = new bootstrap.Modal(modalElement);

      // ¡NUEVAS VARIABLES (Paso 4)!
      let desgloseDeMuebles = {}; // Para guardar {slotId: {datos...}}
      let tipoCocinaActual = null;  // Para saber si es 'pequena' o 'grande'
      let resumenDiv = document.getElementById('simulador-resumen');
      let listaDesgloseUI = document.getElementById('lista-desglose-muebles');      

      // --- 2. POSICIONES (Actualizado Paso 4) ---
      // ¡¡NUEVO!! Añadimos medidas reales (ej: ancho_cm, alto_cm)
      const posiciones = {
        pequena: [
          { top: '60%', left: '3.5%', w: '236px', h: '348px', tipo: 'inferior'},
          { top: '60%', left: '27%', w: '233px', h: '348px', tipo: 'inferior'},
          { top: '60%', left: '50%', w: '230px', h: '348px', tipo: 'inferior'},
          { top: '60%', left: '73%', w: '236px', h: '348px', tipo: 'inferior'},
          { top: '11.37%', left: '3.5%', w: '236px', h: '275px', tipo: 'superior'},
          { top: '11.37%', left: '27%', w: '233px', h: '275px', tipo: 'superior'},
          { top: '11.37%', left: '50%', w: '230px', h: '275px', tipo: 'superior'},
          { top: '11.37%', left: '73%', w: '236px', h: '275px', tipo: 'superior'},
        ],
        // NUEVO: Definimos la cocina en L (5 arriba, 5 abajo, alineados a molduras)
        cocinaL: [
          // --- SUPERIORES (5 espacios) ---
          // Pared izquierda (3 espacios)
          { top: '9%', left: '2%', w: '16%', h: '36%', tipo: 'superior'}, // Extremo izq
          { top: '13%', left: '22%', w: '12%', h: '33%', tipo: 'superior'}, // Medio izq
          { top: '15%', left: '37%', w: '20%', h: '31%', tipo: 'superior'}, // Casi esquina izq
          // Pared derecha (2 espacios)
          { top: '13%', left: '60%', w: '13%', h: '32%', tipo: 'superior'}, // Casi esquina der
          { top: '10%', left: '76%', w: '15%', h: '35%', tipo: 'superior'}, // Medio der

          // --- INFERIORES (5 espacios) ---
          // Pared izquierda (3 espacios)
          { top: '59%', left: '3%', w: '15%', h: '27%', tipo: 'inferior'}, // Extremo izq
          { top: '58%', left: '21%', w: '13%', h: '26%', tipo: 'inferior'}, // Medio izq
          { top: '58%', left: '37%', w: '20%', h: '24%', tipo: 'inferior'}, // Casi esquina izq
          // Pared derecha (2 espacios)
          { top: '58%', left: '60%', w: '12%', h: '26%', tipo: 'inferior'}, // Casi esquina der
          { top: '59%', left: '76%', w: '15%', h: '27%', tipo: 'inferior'}, // Medio der
        ], 
        grande: [
          { top: '60%', left: '5%',  w: '100px', h: '150px', tipo: 'inferior'},
          { top: '60%', left: '20%', w: '100px', h: '150px', tipo: 'inferior'},
          { top: '60%', left: '35%', w: '100px', h: '150px', tipo: 'inferior'},
          { top: '60%', left: '70%', w: '100px', h: '150px', tipo: 'inferior'}, // Esquina
          { top: '30%', left: '5%',  w: '100px', h: '100px', tipo: 'superior'},
          { top: '30%', left: '20%', w: '100px', h: '100px', tipo: 'superior'},
          { top: '30%', left: '35%', w: '100px', h: '100px', tipo: 'superior'},
          { top: '30%', left: '70%', w: '100px', h: '100px', tipo: 'superior'} // Esquina
        ]
      };
      // ¡NUEVO (Paso 5)! Definición de fondos
      const fondosCocina = {
        pequena: [
          { nombre: 'Fondo Clásico (Pequeño)', img: 'static/img/fondos/pequeño/cocina-pequena-fondo.png' },
          { nombre: 'Fondo Verde Salvaje (Pequeño)', img: 'static/img/fondos/pequeño/Fondo Verde - 8(4x4).png' },
          { nombre: 'Fondo Marmol (Pequeño)', img: 'static/img/fondos/pequeño/Fondo Marmol - 8(4x4).png' },
          { nombre: 'Fondo Madera (Pequeño)', img: 'static/img/fondos/pequeño/Fondo Madera- 8(4x4).png' }
        ],
        // NUEVO: Fondos para Cocina en L
        cocinaL: [
          { nombre: 'Madera Normal (En L)', img: 'static/img/fondos/cocinaL/cocina-l-madera-normal.png' },
          { nombre: 'Madera Blanca (En L)', img: 'static/img/fondos/cocinaL/cocina-l-madera-blanca.png' },
          { nombre: 'Mármol (En L)', img: 'static/img/fondos/cocinaL/cocina-l-marmol.png' },
          { nombre: 'Verde (En L)', img: 'static/img/fondos/cocinaL/cocina-l-verde.png' }
        ],
        grande: [
          { nombre: 'Fondo Clásico (Grande)', img: 'static/img/fondos/grande/cocina-grande-fondo.jpg' },
          { nombre: 'Fondo Mármol (Grande)', img: 'static/img/cocina-grande-fondo-marmol.jpg' }
        ]
      };

      // --- 3. OBTENER ELEMENTOS DEL DOM ---
      const selDiv = document.getElementById('simulador-seleccion');
      const simArea = document.getElementById('simulador-area');
      const btnPequena = document.getElementById('btn-cocina-pequena');
      const btnGrande = document.getElementById('btn-cocina-grande');
      
      // NUEVO: Botón Cocina L
      const btnCocinaL = document.getElementById('btn-cocina-l');

      const simFondo = document.getElementById('simulador-fondo');
      const simSlots = document.getElementById('simulador-slots');
      // ¡NUEVO (Paso 5)!
      const selFondoDiv = document.getElementById('simulador-seleccion-fondo');
      const fondosGridUI = document.getElementById('fondos-opciones-grid');
      const btnExportar = document.getElementById('btn-exportar-pdf');

      // Elementos del Modal
      const modalTitulo = document.getElementById('modal-titulo');
      const modalCuerpoGrid = document.getElementById('modal-cuerpo');
      const modalPreview = document.getElementById('modal-preview');
      const btnVolverGrid = document.getElementById('btn-volver-grid');
      const btnAddMueble = document.getElementById('btn-add-mueble');
      const previewNombre = document.getElementById('preview-nombre-mueble');
      const carouselIndicators = document.getElementById('carousel-preview-indicators');
      const carouselInner = document.getElementById('carousel-preview-inner');



// --- 4. CONFIGURACIÓN DE RUTAS JSON (NUEVO) ---
      const rutasMuebles = {
        pequena: 'static/muebles.json',       // Ruta original (ahora solo para pequeña)
        cocinaL: 'static/muebles_l.json',     // Ruta nueva para L
        grande:  'static/muebles_grande.json' // Ruta nueva para Grande
      };

      // Función para cargar el JSON correcto según la cocina
      function cargarMueblesPorTipo(tipo) {
        const ruta = rutasMuebles[tipo];
        
        fetch(ruta)
          .then(response => {
            if (!response.ok) throw new Error(`No se encontró: ${ruta}`);
            return response.json();
          })
          .then(data => {
            baseDeDatosMuebles = data; // Actualiza la base de datos
            console.log(`Muebles cargados desde: ${ruta}`);
          })
          .catch(error => console.error('Error cargando JSON:', error));
      }
      // --- 5. ASIGNAR EVENTOS ---
      btnPequena.addEventListener('click', (e) => {
        e.preventDefault(); 
        iniciarSimulador('pequena');
      });

      // NUEVO: Evento para Cocina en L
      if(btnCocinaL) {
        btnCocinaL.addEventListener('click', (e) => {
          e.preventDefault();
          iniciarSimulador('cocinaL');
        });
      }

      // ¡NUEVO (Paso 5)! Evento para el botón "Exportar PDF"
      btnExportar.addEventListener('click', () => {
        window.print(); // Tu idea: ¡simple y efectiva!
      });

      btnGrande.addEventListener('click', (e) => {
        e.preventDefault();
        iniciarSimulador('grande');
      });

      // [NUEVO] Evento para el botón "Volver a la cuadrícula"
      btnVolverGrid.addEventListener('click', () => {
        mostrarGridView(); // Muestra la cuadrícula, oculta el preview
      });

      // [NUEVO] Evento para el botón "Añadir a la Cocina"
      btnAddMueble.addEventListener('click', (e) => {
        const imgSlot = e.currentTarget.dataset.imgSlot; 
        // ¡NUEVO (Paso 4)! Obtener datos para el desglose
        const muebleId = e.currentTarget.dataset.muebleId;
        const muebleNombre = e.currentTarget.dataset.muebleNombre;
        const slotId = slotActivo.dataset.slotId;
        const dataset = e.currentTarget.dataset;
        console.log("Intentando cargar esta imagen en el slot:", dataset.imgSlot);
        
        // Obtenemos los datos de posición (incluyendo medidas reales)
        const posData = posiciones[tipoCocinaActual][slotId];
        slotActivo.style.backgroundImage = `url(${dataset.imgSlot})`;

        // Guardamos en nuestro desglose
        desgloseDeMuebles[slotId] = {
          nombre: muebleNombre,
          ancho: dataset.muebleAncho, // <-- CAMBIO
          alto: dataset.muebleAlto    // <-- CAMBIO
        };
        
        // Aplicamos la imagen SIN FONDO al slot
        slotActivo.style.backgroundImage = `url(${dataset.imgSlot})`;
        slotActivo.innerHTML = '';
        slotActivo.style.border = '1px solid var(--gold)';

        // Cerramos el modal
        modalBootstrap.hide();
        // ¡OPCIONAL! Añade esto para tratar de eliminar el foco
        e.currentTarget.blur();
        slotActivo = null;

        // ¡NUEVO! Actualizamos la tabla
        actualizarDesgloseUI();
      });

      // --- 6. FUNCIONES DEL MODAL ---

      // [MODIFICADA] Esta función ahora prepara el modal y la cuadrícula
      function abrirModalConMuebles(tipoSlot) {
        mostrarGridView(tipoSlot); // Mostramos la cuadrícula
        
        // Añadir listeners a las opciones de la cuadrícula
        modalCuerpoGrid.querySelectorAll('.mueble-opcion').forEach(opcion => {
          opcion.addEventListener('click', handleGridClick);
        });

        // Abrir el modal
        modalBootstrap.show();
      }

      // [NUEVA] Maneja el clic en una opción de la cuadrícula
      // [NUEVA] Maneja el clic en una opción de la cuadrícula
      function handleGridClick(e) {
        e.preventDefault();
        const muebleId = e.currentTarget.dataset.id;

        if (muebleId === 'limpiar') {
          // Opción "Quitar mueble"
          slotActivo.style.backgroundImage = 'none';
          slotActivo.innerHTML = '<i class="fa-solid fa-plus"></i>';
          slotActivo.style.border = '2px dashed var(--gold)';
          
          // ¡NUEVO (Paso 4)! Limpiar del desglose
          const slotId = slotActivo.dataset.slotId;
          delete desgloseDeMuebles[slotId]; // Elimina el item del objeto
          actualizarDesgloseUI(); // Actualiza la tabla

          modalBootstrap.hide();
          slotActivo = null;
        } else {
          // Clic en un mueble -> Mostrar previsualización
          const mueble = baseDeDatosMuebles.find(m => m.id === muebleId);
          if (mueble) {
            mostrarPreview(mueble);
          }
        }
      }

      // [NUEVA] Muestra la vista de cuadrícula y oculta el preview
      function mostrarGridView(tipoSlot) {
        // Rellenar la cuadrícula solo si se pasa el tipoSlot (al abrir por primera vez)
        if (tipoSlot) {
          const mueblesFiltrados = baseDeDatosMuebles.filter(mueble => mueble.tipo === tipoSlot);
          modalCuerpoGrid.innerHTML = ''; // Limpiar

          // Opción "Quitar mueble"
          modalCuerpoGrid.innerHTML += `
            <div class="col-md-4">
              <a href="#" class="mueble-opcion" data-id="limpiar">
                <div style="width: 100%; height: 120px; display: grid; place-content: center; font-size: 30px; color: #777;">
                  <i class="fa-solid fa-ban"></i>
                </div>
                <h6>Quitar mueble</h6>
              </a>
            </div>
          `;
          
          // Cargar muebles
          mueblesFiltrados.forEach(mueble => {
            modalCuerpoGrid.innerHTML += `
              <div class="col-md-4">
                <a href="#" class="mueble-opcion" data-id="${mueble.id}">
                  <img src="${mueble.imagen_grid}" alt="${mueble.nombre}">
                  <h6>${mueble.nombre}</h6>
                </a>
              </div>
            `;
          });
        }
        
        // Ajustar visibilidad y título
        modalTitulo.textContent = `Selecciona un mueble ${tipoSlot || ''}`;
        modalCuerpoGrid.classList.remove('hidden');
        modalPreview.classList.add('hidden');
        btnVolverGrid.classList.add('hidden');
      }

      // [NUEVA] Muestra la vista de preview y oculta la cuadrícula
      function mostrarPreview(mueble) {
        // Ajustar visibilidad y título
        modalTitulo.textContent = mueble.nombre;
        modalCuerpoGrid.classList.add('hidden');
        modalPreview.classList.remove('hidden');
        btnVolverGrid.classList.remove('hidden');
        modalTitulo.textContent = mueble.nombre;
        modalCuerpoGrid.classList.add('hidden');
        modalPreview.classList.remove('hidden');
        btnVolverGrid.classList.remove('hidden');

        // Rellenar datos del preview
        previewNombre.textContent = mueble.nombre;
        // previewImgSlot.src = mueble.imagen_slot; // Imagen con fondo

        // ¡MODIFICADO (Paso 4)! Guardamos MÁS datos en el botón
        btnAddMueble.dataset.imgSlot = mueble.imagen_slot;
        btnAddMueble.dataset.muebleId = mueble.id;
        btnAddMueble.dataset.muebleNombre = mueble.nombre;
        btnAddMueble.dataset.muebleAncho = mueble.ancho_cm; // <-- NUEVO
        btnAddMueble.dataset.muebleAlto = mueble.alto_cm;  // <-- NUEVO

        // Limpiar carrusel anterior
        carouselIndicators.innerHTML = '';
        carouselInner.innerHTML = '';

        // Construir el carrusel con las imágenes "Con Fondo"
        mueble.preview_cf.forEach((imgUrl, index) => {
          const esActiva = (index === 0) ? 'active' : '';

          // Añadir indicador (puntito)
          carouselIndicators.innerHTML += `
            <button type="button" data-bs-target="#carousel-mueble" data-bs-slide-to="${index}" 
                    class="${esActiva}" ${esActiva ? 'aria-current="true"' : ''}></button>
          `;

          // Añadir imagen al carrusel
          carouselInner.innerHTML += `
            <div class="carousel-item ${esActiva}">
              <img src="${imgUrl}" alt="Vista ${index + 1} de ${mueble.nombre}">
            </div>
          `;
        });
      }


      // --- 7. FUNCIÓN PRINCIPAL (MODIFICADA Paso 4) ---
      // [MODIFICADA (Paso 5)] Esta función ahora solo muestra la selección de fondos
      function iniciarSimulador(tipo) {
        // Ocultar selección de tipo, mostrar selección de fondo
        selDiv.classList.add('hidden');
        selFondoDiv.classList.remove('hidden');

        // Guardamos el tipo de cocina para usarlo después
        tipoCocinaActual = tipo; 

        // ---> AQUÍ AGREGAS ESTA LÍNEA <---
        cargarMueblesPorTipo(tipo); 
        // ---------------------------------

        // Limpiamos y mostramos los fondos
        fondosGridUI.innerHTML = '';
        const fondos = fondosCocina[tipo];
        // Verificamos si hay fondos definidos para evitar errores
        if(fondos) {
            fondos.forEach(fondo => {
            const htmlFondo = `
                <div class="col-md-4">
                <a href="#" class="fondo-opcion" data-img-src="${fondo.img}">
                    <img src="${fondo.img}" alt="${fondo.nombre}">
                    <h6>${fondo.nombre}</h6>
                </a>
                </div>
            `;
            fondosGridUI.innerHTML += htmlFondo;
            });

            // Añadir listeners a las *nuevas* opciones de fondo
            fondosGridUI.querySelectorAll('.fondo-opcion').forEach(opcion => {
            opcion.addEventListener('click', seleccionarFondo);
            });
        }
      }

      // ¡NUEVA (Paso 5)! Se llama al hacer clic en un fondo
      function seleccionarFondo(e) {
        e.preventDefault();
        const imgSrc = e.currentTarget.dataset.imgSrc;

        // Ocultar selección de fondo, mostrar área de simulación
        selFondoDiv.classList.add('hidden');
        simArea.classList.remove('hidden');

        // Poner la imagen de fondo seleccionada
        simFondo.src = imgSrc;
        
        // Ahora sí, dibujamos los slots
        dibujarSlots(tipoCocinaActual);
      }

      // ¡NUEVA (Paso 5)! Esta es la lógica que antes estaba en iniciarSimulador
      function dibujarSlots(tipo) {
        simSlots.innerHTML = '';

        // Mostrar y reiniciar el desglose
        resumenDiv.classList.remove('hidden');
        desgloseDeMuebles = {}; // Limpia el desglose
        actualizarDesgloseUI(); // Actualiza la tabla (vacía)

        let slotsConfig = posiciones[tipo];

        // Si slotsConfig es vacío (Cocina L), simplemente no entra al loop y no dibuja nada.
        if (slotsConfig && slotsConfig.length > 0) {
            slotsConfig.forEach((pos, index) => {
            const slot = document.createElement('div');
            slot.className = 'mueble-slot';
            slot.dataset.slotId = index; 
            slot.dataset.tipo = pos.tipo;
            
            slot.style.top = pos.top;
            slot.style.left = pos.left;
            slot.style.width = pos.w;
            slot.style.height = pos.h;
            
            slot.innerHTML = '<i class="fa-solid fa-plus"></i>';

            slot.addEventListener('click', (e) => {
                slotActivo = e.currentTarget; 
                const tipoSlot = slotActivo.dataset.tipo;
                abrirModalConMuebles(tipoSlot);
            });

            simSlots.appendChild(slot);
            });
        }
      }
      
      // --- NUEVA FUNCIÓN (Paso 4) ---
      // Actualiza la tabla HTML con los datos de 'desgloseDeMuebles'
      function actualizarDesgloseUI() {
        // Limpiamos la tabla
        listaDesgloseUI.innerHTML = '';

        // Obtenemos las claves (slotId) de los muebles añadidos
        const mueblesAñadidosIds = Object.keys(desgloseDeMuebles);

        if (mueblesAñadidosIds.length === 0) {
          // Si no hay muebles, mostrar mensaje
          listaDesgloseUI.innerHTML = `
            <tr>
              <td colspan="3" class="text-center text-muted">Aún no has añadido muebles.</td>
            </tr>
          `;
        } else {
          // Si hay muebles, crear una fila por cada uno
          mueblesAñadidosIds.forEach(slotId => {
            const mueble = desgloseDeMuebles[slotId];
            const filaHtml = `
              <tr>
                <td><strong>${mueble.nombre}</strong></td>
                <td>${mueble.ancho}</td>
                <td>${mueble.alto}</td>
              </tr>
            `;
            listaDesgloseUI.innerHTML += filaHtml;
          });
        }
      }
    });
  </script>
  </body>
</html>